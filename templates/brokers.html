<!-- Broker Accounts Section -->
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-2xl font-bold tracking-tight text-white mb-1">Broker Accounts</h2>
            <p class="text-sm text-slate-400">Manage your connected trading accounts and API tokens.</p>
        </div>
        <a href="{{ url_for('add_broker') }}"
            class="inline-flex items-center justify-center rounded-lg text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 bg-blue-600 text-white hover:bg-blue-700 h-10 px-4 py-2 shadow-lg shadow-blue-500/20">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add Broker
        </a>
    </div>

    <!-- Broker List Card -->
    <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-xl">
        {% if broker_accounts %}
        <div class="divide-y divide-slate-700">
            {% for broker in broker_accounts %}
            <div class="flex flex-col md:flex-row md:items-center justify-between p-6 gap-6 md:gap-0 transition-colors hover:bg-slate-750"
                data-broker-id="{{ broker.broker_id }}">

                <!-- Broker Info -->
                <div class="flex items-center gap-4">
                    <!-- Icon Avatar -->
                    <div
                        class="flex h-12 w-12 shrink-0 items-center justify-center rounded-full border border-slate-600 bg-slate-700 shadow-sm">
                        {% if broker.broker_type == 'fyers' %}
                        <span class="text-sm font-bold text-blue-400">FY</span>
                        {% elif broker.broker_type == 'zerodha' %}
                        <span class="text-sm font-bold text-orange-400">ZE</span>
                        {% else %}
                        <span class="text-sm font-bold text-slate-400">BR</span>
                        {% endif %}
                    </div>

                    <div class="space-y-1">
                        <div class="flex items-center gap-2">
                            <span class="text-lg font-semibold text-white broker-display-name tracking-tight">{{
                                broker.display_name }}</span>
                            {% if broker.is_default %}
                            <span
                                class="inline-flex items-center rounded-md border border-yellow-500/20 bg-yellow-500/10 px-2 py-0.5 text-[10px] font-bold tracking-wide text-yellow-500 uppercase">
                                Default
                            </span>
                            {% endif %}
                        </div>
                        <div class="flex items-center gap-2 text-sm text-slate-400 font-medium">
                            <span class="capitalize">{{ broker.broker_type }}</span>
                            <span class="text-slate-600">â€¢</span>
                            {% if broker.token_status == 'valid' %}
                            <span class="flex items-center gap-1.5 text-green-400">
                                <span
                                    class="h-1.5 w-1.5 rounded-full bg-green-400 shadow-[0_0_6px_rgba(74,222,128,0.6)]"></span>
                                Connected
                            </span>
                            {% else %}
                            <span class="flex items-center gap-1.5 text-red-500">
                                <span class="h-1.5 w-1.5 rounded-full bg-red-500"></span>
                                Disconnected
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="flex items-center gap-6">

                    <!-- Trading Mode -->
                    <div class="flex items-center gap-2">
                        <div class="relative group">
                            <select
                                class="broker-mode-select h-9 w-[150px] appearance-none rounded-lg border border-slate-600 bg-slate-900 px-3 py-1 text-xs font-medium text-slate-200 hover:border-slate-500 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 transition-all cursor-pointer shadow-sm"
                                data-broker-id="{{ broker.broker_id }}" style="padding-right: 2.5rem;">
                                <option value="NORMAL" {% if broker.trading_mode=='NORMAL' %}selected{% endif %}>ðŸŸ¢
                                    Trading Active</option>
                                <option value="EXIT_ONLY" {% if broker.trading_mode=='EXIT_ONLY' %}selected{% endif %}>
                                    ðŸŸ  Exit Only</option>
                                <option value="PAUSED" {% if broker.trading_mode=='PAUSED' %}selected{% endif %}>ðŸ”´
                                    Paused</option>
                            </select>
                            <div
                                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400 group-hover:text-slate-300">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- Enable Switch -->
                    <div class="flex items-center px-2">
                        {% if broker.enabled %}
                        <button onclick="toggleBroker('{{ broker.broker_id }}')"
                            class="relative inline-flex h-6 w-11 shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 bg-green-500"
                            role="switch" aria-checked="true">
                            <span class="sr-only">Enable broker</span>
                            <span aria-hidden="true"
                                class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out translate-x-5"></span>
                        </button>
                        {% else %}
                        <button onclick="toggleBroker('{{ broker.broker_id }}')"
                            class="relative inline-flex h-6 w-11 shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 bg-slate-700"
                            role="switch" aria-checked="false">
                            <span class="sr-only">Enable broker</span>
                            <span aria-hidden="true"
                                class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-slate-400 shadow ring-0 transition duration-200 ease-in-out translate-x-0"></span>
                        </button>
                        {% endif %}
                    </div>

                    <!-- Action Menu (Custom Dropdown) -->
                    <div class="relative dropdown-container">
                        <button onclick="toggleDropdown('menu-{{ broker.broker_id }}')"
                            class="flex h-9 w-9 items-center justify-center rounded-lg border border-slate-600 bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white transition-all shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <circle cx="12" cy="12" r="1"></circle>
                                <circle cx="12" cy="5" r="1"></circle>
                                <circle cx="12" cy="19" r="1"></circle>
                            </svg>
                        </button>

                        <!-- Dropdown Menu -->
                        <div id="menu-{{ broker.broker_id }}"
                            class="hidden dropdown-menu absolute right-0 mt-2 w-48 origin-top-right rounded-lg bg-slate-800 border border-slate-700 shadow-xl ring-1 ring-black ring-opacity-5 focus:outline-none z-50">
                            <div class="p-1">
                                <button onclick="editBrokerName('{{ broker.broker_id }}', '{{ broker.display_name }}')"
                                    class="flex w-full items-center rounded-md px-3 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="mr-2 text-slate-400">
                                        <path d="M12 20h9"></path>
                                        <path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"></path>
                                    </svg>
                                    Edit Name
                                </button>
                                {% if not broker.is_default %}
                                <button onclick="setDefaultBroker('{{ broker.broker_id }}')"
                                    class="flex w-full items-center rounded-md px-3 py-2 text-sm text-blue-400 hover:bg-blue-900/20 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="mr-2">
                                        <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
                                        <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
                                        <path d="M4 22h16"></path>
                                        <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
                                        <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
                                        <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
                                    </svg>
                                    Set as Default
                                </button>
                                {% endif %}
                            </div>
                            <div class="h-px bg-slate-700 my-1 mx-1"></div>
                            <div class="p-1">
                                <button onclick="deleteBroker('{{ broker.broker_id }}', '{{ broker.display_name }}')"
                                    class="flex w-full items-center rounded-md px-3 py-2 text-sm text-red-400 hover:bg-red-900/20 hover:text-red-300 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="mr-2">
                                        <path d="M3 6h18"></path>
                                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                                    </svg>
                                    Delete Broker
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="flex flex-col items-center justify-center py-16 text-center">
            <div
                class="flex h-16 w-16 items-center justify-center rounded-full bg-slate-800 border border-slate-700 mb-6 shadow-inner">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="text-slate-500">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            </div>
            <h3 class="text-xl font-semibold text-white mb-2">No brokers added</h3>
            <p class="mb-6 max-w-sm text-slate-400">Connect your Fyers or Zerodha account to start automating your
                trades.</p>
            <a href="{{ url_for('add_broker') }}"
                class="inline-flex items-center justify-center rounded-lg text-sm font-semibold bg-blue-600 text-white hover:bg-blue-700 h-10 px-6 shadow-lg shadow-blue-600/20 transition-all hover:scale-105">
                Setup First Broker
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function toggleDropdown(id) {
        const dropdown = document.getElementById(id);
        const allDropdowns = document.querySelectorAll('.dropdown-menu');

        // Close other dropdowns
        allDropdowns.forEach(d => {
            if (d.id !== id) d.classList.add('hidden');
        });

        // Toggle current
        dropdown.classList.toggle('hidden');
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function (event) {
        const isDropdownButton = event.target.closest('button[onclick^="toggleDropdown"]');
        const isDropdownMenu = event.target.closest('.dropdown-menu');

        if (!isDropdownButton && !isDropdownMenu) {
            document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.add('hidden'));
        }
    });

    function toggleBroker(brokerId) {
        fetch(`/toggle-broker/${brokerId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            });
    }

    function editBrokerName(brokerId, currentName) {
        // Simple prompt for now, can be upgraded to modal later
        const newName = prompt("Enter new display name:", currentName);
        if (newName && newName !== currentName) {
            const formData = new FormData();
            formData.append('broker_id', brokerId);
            formData.append('new_name', newName);

            fetch('/update-broker-name', {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') location.reload();
                    else alert(data.message);
                });
        }
    }

    function setDefaultBroker(brokerId) {
        if (confirm('Set this broker as default?')) {
            fetch(`/set-default-broker/${brokerId}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') location.reload();
                    else alert(data.message);
                });
        }
    }

    function deleteBroker(brokerId, name) {
        if (confirm(`Are you sure you want to DELETE broker "${name}"? This action cannot be undone.`)) {
            fetch(`/delete-broker/${brokerId}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') location.reload();
                    else alert(data.message);
                });
        }
    }
</script>