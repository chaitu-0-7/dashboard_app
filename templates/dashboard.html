{% extends "base.html" %}

{% block title %}Dashboard - Nifty Shop{% endblock %}
{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Real-time overview of your trading performance{% endblock %}

{% block header_actions %}
{% if brokers and brokers|length > 1 %}
<select id="brokerSelector" class="shadcn-select" onchange="window.location.href='?broker=' + this.value">
    <option value="all" {% if selected_broker_id=='all' %}selected{% endif %}>All Brokers</option>
    {% for b in brokers %}
    <option value="{{ b.broker_id }}" {% if selected_broker_id==b.broker_id %}selected{% endif %}>
        {{ b.display_name or b.broker_type|capitalize }}
    </option>
    {% endfor %}
</select>
{% endif %}
{% endblock %}

{% block content %}
<!-- Metrics Grid -->
<div class="metrics-grid">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Holdings P&L</h3>
            <i data-feather="dollar-sign" class="text-muted" style="width: 16px;"></i>
        </div>
        <p class="metric-value {% if holdings_pnl > 0 %}text-success{% elif holdings_pnl < 0 %}text-danger{% endif %}">
            ₹{{ '%.2f' | format(holdings_pnl) }}
        </p>
        <div class="metric-trend">
            <span class="text-muted">Unrealized P&L</span>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Open Positions</h3>
            <i data-feather="layers" class="text-muted" style="width: 16px;"></i>
        </div>
        <p class="metric-value">{{ open_positions_count }}</p>
        <div class="metric-trend">
            <span class="text-muted">Active trades</span>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Today's Trades</h3>
            <i data-feather="activity" class="text-muted" style="width: 16px;"></i>
        </div>
        <p class="metric-value">{{ recent_trades_count }}</p>
        <div class="metric-trend">
            <span class="text-muted">Executed today</span>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="charts-grid">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Daily P&L Performance</h3>
        </div>
        <div class="chart-container">
            <canvas id="dailyPnlChart"></canvas>
        </div>
    </div>
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Capital Utilization</h3>
        </div>
        <div style="padding: 1.5rem;">
            <!-- Progress Bar -->
            <div style="margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span class="text-muted small">Used: ₹{{ '{:,.0f}'.format(capital_utilization.used) }}</span>
                    <span class="text-muted small">Available: ₹{{ '{:,.0f}'.format(capital_utilization.available)
                        }}</span>
                </div>
                <div
                    style="width: 100%; height: 24px; background-color: #1e293b; border-radius: 12px; overflow: hidden; position: relative;">
                    <div
                        style="width: {{ capital_utilization.used_percentage }}%; height: 100%; background: linear-gradient(90deg, #3b82f6, #2563eb); transition: width 0.3s ease;">
                    </div>
                    <div
                        style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-size: 0.75rem; font-weight: 600;">
                        {{ '{:.1f}'.format(capital_utilization.used_percentage) }}% Used
                    </div>
                </div>
            </div>

            <!-- Metrics Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div style="text-align: center; padding: 1rem; background-color: #1e293b; border-radius: 8px;">
                    <div class="text-muted small" style="margin-bottom: 0.5rem;">Total Capital</div>
                    <div style="font-size: 1.25rem; font-weight: 600; color: #3b82f6;">₹{{
                        '{:,.0f}'.format(capital_utilization.total) }}</div>
                </div>
                <div style="text-align: center; padding: 1rem; background-color: #1e293b; border-radius: 8px;">
                    <div class="text-muted small" style="margin-bottom: 0.5rem;">Avg Position Size</div>
                    <div style="font-size: 1.25rem; font-weight: 600; color: #10b981;">₹{{
                        '{:,.0f}'.format(capital_utilization.avg_position_size) }}</div>
                </div>
                <div style="text-align: center; padding: 1rem; background-color: #1e293b; border-radius: 8px;">
                    <div class="text-muted small" style="margin-bottom: 0.5rem;">Current Positions</div>
                    <div style="font-size: 1.25rem; font-weight: 600; color: #f59e0b;">{{
                        capital_utilization.current_positions }}</div>
                </div>
                <div style="text-align: center; padding: 1rem; background-color: #1e293b; border-radius: 8px;">
                    <div class="text-muted small" style="margin-bottom: 0.5rem;">Can Open</div>
                    <div style="font-size: 1.25rem; font-weight: 600; color: #8b5cf6;">{{
                        capital_utilization.positions_can_open }}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h3 class="card-title">Cumulative P&L Growth</h3>
    </div>
    <div class="chart-container" style="height: 350px;">
        <canvas id="cumulativePnlChart"></canvas>
    </div>
</div>

<!-- Recent Activity Section -->
<h2 class="page-title" style="font-size: 1.5rem; margin-bottom: 1.5rem;">Recent Activity</h2>

{% if daily_data %}
{% for date_str, data in daily_data.items() %}
<div class="card mb-4">
    <div class="card-header" style="border-bottom: 1px solid var(--border); padding-bottom: 1rem;">
        <div class="flex-between w-100">
            <div class="flex-center">
                <i data-feather="calendar" class="text-muted mr-2" style="width: 18px; margin-right: 8px;"></i>
                <span style="font-weight: 600; font-size: 1.1rem;">{{ date_str }}</span>
            </div>
            <div class="flex-center gap-4">
                <span class="badge badge-info">{{ data.executed_trades|length }} Trades</span>
                <span class="badge badge-warning">{{ data.logs|length }} Logs</span>
            </div>
        </div>
    </div>

    <div style="padding-top: 1rem;">
        <!-- Trades Table -->
        <h4 style="margin: 0.5rem 0 1rem; font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase;">
            Executed Trades</h4>
        {% if data.executed_trades %}
        <div class="table-container" style="margin-bottom: 1.5rem;">
            <table>
                <thead>
                    <tr>
                        <th>Action</th>
                        <th>Symbol</th>
                        <th>Broker</th>
                        <th>Qty</th>
                        <th>Price</th>
                        <th>Status</th>
                        <th>Profit</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trade in data.executed_trades %}
                    <tr>
                        <td>
                            <span
                                class="badge {% if trade.action == 'BUY' %}badge-success{% else %}badge-danger{% endif %}">
                                {{ trade.action }}
                            </span>
                        </td>
                        </td>
                        <td style="font-weight: 500;">{{ trade.symbol }}</td>
                        <td>
                            {% if trade.broker_id %}
                            <span class="badge badge-secondary" style="font-size: 0.75rem;">{{
                                trade.broker_id.split('_')[0] }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>{{ trade.quantity }}</td>
                        <td>₹{{ '%.2f' | format(trade.price) }}</td>
                        <td>
                            {% if trade.filled %}
                            <span class="text-success flex-center" style="justify-content: flex-start;">
                                <i data-feather="check-circle" style="width: 14px; margin-right: 4px;"></i> Filled
                            </span>
                            {% else %}
                            <span class="text-warning">Pending</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if trade.profit is not none %}
                            <span
                                class="{% if trade.profit > 0 %}text-success{% elif trade.profit < 0 %}text-danger{% endif %}"
                                style="font-weight: 600;">
                                ₹{{ '%.2f' | format(trade.profit) }}
                            </span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted" style="font-style: italic; margin-bottom: 1.5rem;">No trades executed on this day.</p>
        {% endif %}

        <!-- Logs Toggle -->
        <details class="custom-details">
            <summary class="btn btn-outline btn-sm" style="display: inline-flex; width: auto; font-size: 0.8rem;">
                <i data-feather="list" style="width: 14px; margin-right: 6px;"></i> View System Logs
            </summary>
            <div class="mt-4 table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Broker</th>
                            <th>Level</th>
                            <th>Message</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in data.logs %}
                        <tr>
                            <td style="white-space: nowrap; color: var(--text-muted);">{{
                                log.timestamp.strftime('%H:%M:%S') }}</td>
                            <td>
                                {% if log.broker_id %}
                                <span class="badge badge-secondary" style="font-size: 0.75rem;">{{
                                    log.broker_id.split('_')[0] }}</span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <span
                                    class="badge {% if log.level == 'INFO' %}badge-info{% elif log.level == 'WARNING' %}badge-warning{% elif log.level == 'ERROR' %}badge-danger{% endif %}">
                                    {{ log.level }}
                                </span>
                            </td>
                            <td style="font-family: monospace; font-size: 0.85rem;">{{ log.message }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </details>
    </div>
</div>
{% endfor %}

<div class="flex-center mt-4 gap-2">
    <button class="btn btn-outline" {% if page==1 %}disabled{% endif %}
        onclick="window.location.href='/?page={{ page - 1 }}'">
        <i data-feather="chevron-left" style="width: 16px; margin-right: 4px;"></i> Previous
    </button>
    <button class="btn btn-outline" {% if not has_more_days %}disabled{% endif %}
        onclick="window.location.href='/?page={{ page + 1 }}'">
        Next <i data-feather="chevron-right" style="width: 16px; margin-left: 4px;"></i>
    </button>
</div>

{% else %}
<div class="card flex-center" style="padding: 4rem; flex-direction: column;">
    <div style="background: var(--bg-hover); padding: 1rem; border-radius: 50%; margin-bottom: 1rem;">
        <i data-feather="inbox" style="width: 32px; height: 32px; color: var(--text-muted);"></i>
    </div>
    <h3 class="text-muted">No trading activity found</h3>
    <p class="text-dim">Ensure the bot is running and generating data.</p>
</div>
{% endif %}

{% endblock %}

{% block scripts %}


<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Daily P&L Chart
        const dailyPnlCtx = document.getElementById('dailyPnlChart').getContext('2d');
        const gradient = dailyPnlCtx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, 'rgba(59, 130, 246, 0.2)'); // Blue with opacity
        gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');

        new Chart(dailyPnlCtx, {
            type: 'line',
            data: {
                labels: {{ chart_labels | safe }},
        datasets: [{
            label: 'Daily P&L',
            data: {{ chart_values | safe }},
        backgroundColor: gradient,
        borderColor: '#3b82f6',
        borderWidth: 2,
        pointBackgroundColor: '#1e293b',
        pointBorderColor: '#3b82f6',
        pointBorderWidth: 2,
        pointRadius: 4,
        pointHoverRadius: 6,
        fill: true,
        tension: 0.4
                }]
            },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            tooltip: {
                backgroundColor: '#1e293b',
                titleColor: '#f8fafc',
                bodyColor: '#cbd5e1',
                borderColor: '#334155',
                borderWidth: 1,
                padding: 10,
                callbacks: {
                    label: function (context) {
                        let label = context.dataset.label || '';
                        if (label) label += ': ';
                        if (context.parsed.y !== null) {
                            label += new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(context.parsed.y);
                        }
                        return label;
                    }
                }
            }
        },
        scales: {
            y: {
                grid: { color: '#334155', drawBorder: false },
                ticks: { color: '#94a3b8' }
            },
            x: {
                grid: { display: false },
                ticks: { color: '#94a3b8' }
            }
        }
    }
        });

    // Cumulative P&L Chart
    const cumulativePnlData = {{ cumulative_pnl_data | safe }};
    const cumulativePnlCtx = document.getElementById('cumulativePnlChart').getContext('2d');

    // Create gradient
    const pnlGradient = cumulativePnlCtx.createLinearGradient(0, 0, 0, 300);
    pnlGradient.addColorStop(0, 'rgba(16, 185, 129, 0.2)'); // Emerald with opacity
    pnlGradient.addColorStop(1, 'rgba(16, 185, 129, 0)');

    new Chart(cumulativePnlCtx, {
        type: 'line',
        data: {
            labels: cumulativePnlData.map(d => d.date),
            datasets: [{
                label: 'Cumulative P&L',
                data: cumulativePnlData.map(d => d.pnl),
                borderColor: '#10b981',
                backgroundColor: pnlGradient,
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function (context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            if (context.parsed.y !== null) {
                                label += new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(context.parsed.y);
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    grid: { color: '#334155', drawBorder: false },
                    ticks: { color: '#94a3b8' }
                },
                x: {
                    grid: { display: false },
                    ticks: { display: false }
                }
            }
        }
    });


    });
</script>
{% endblock %}