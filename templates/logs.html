{% extends "base.html" %}

{% block title %}System Logs - Nifty Shop{% endblock %}
{% block page_title %}System Logs{% endblock %}
{% block page_subtitle %}Monitor application activity and debug issues{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header" style="flex-direction: column; align-items: flex-start; gap: 1rem;">
        <h3 class="card-title">Log Filters</h3>
        <div class="flex-between w-100" style="flex-wrap: wrap; gap: 1rem;">
            <input type="text" id="log-search" placeholder="Search logs..."
                style="flex: 1; min-width: 200px; padding: 0.6rem; background: var(--bg-app); border: 1px solid var(--border); color: var(--text-main); border-radius: var(--radius-sm);">

            <select id="log-level-filter"
                style="padding: 0.6rem; background: var(--bg-app); border: 1px solid var(--border); color: var(--text-main); border-radius: var(--radius-sm);">
                <option value="">All Levels</option>
                <option value="INFO">INFO</option>
                <option value="WARNING">WARNING</option>
                <option value="ERROR">ERROR</option>
            </select>

            <input type="date" id="log-date-filter"
                style="padding: 0.6rem; background: var(--bg-app); border: 1px solid var(--border); color: var(--text-main); border-radius: var(--radius-sm);">
        </div>
        <div id="loading-indicator" class="text-muted" style="display: none; font-size: 0.875rem;">
            <i data-feather="loader" class="spin" style="width: 14px; margin-right: 6px;"></i> Loading logs...
        </div>
    </div>

    <div class="table-container" style="border: none; margin-bottom: 0;">
        <table id="logs-table">
            <thead>
                <tr>
                    <th data-sort-key="timestamp" style="cursor: pointer;">Timestamp <i data-feather="chevron-down"
                            style="width: 14px;"></i></th>
                    <th>Level</th>
                    <th>Message</th>
                </tr>
            </thead>
            <tbody id="log-table-body">
                <!-- Logs will be loaded here -->
            </tbody>
        </table>
    </div>

    <div id="no-logs-message" class="p-5 text-center text-muted" style="display: none;">
        <i data-feather="file-text" style="width: 32px; height: 32px; margin-bottom: 1rem; opacity: 0.5;"></i>
        <p>No logs found matching your criteria.</p>
    </div>

    <div class="p-4 text-center border-top" style="border-color: var(--border) !important;">
        <button id="load-more-logs" class="btn btn-outline">Load More Logs</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    let hasMoreLogs = true;
    const logTableBody = document.getElementById('log-table-body');
    const loadMoreButton = document.getElementById('load-more-logs');
    const noLogsMessage = document.getElementById('no-logs-message');
    const logsTable = document.getElementById('logs-table');
    const logSearchInput = document.getElementById('log-search');
    const logLevelFilter = document.getElementById('log-level-filter');
    const logDateFilter = document.getElementById('log-date-filter');
    const loadingIndicator = document.getElementById('loading-indicator');

    async function fetchLogs(reset = false) {
        if (reset) {
            currentPage = 1;
            logTableBody.innerHTML = '';
            hasMoreLogs = true;
            noLogsMessage.style.display = 'none';
            logsTable.style.display = 'table';
            loadMoreButton.style.display = 'inline-flex';
        }

        if (!hasMoreLogs) return;

        loadMoreButton.disabled = true;
        loadMoreButton.innerHTML = '<i data-feather="loader" class="spin" style="width: 14px; margin-right: 6px;"></i> Loading...';
        feather.replace();
        loadingIndicator.style.display = 'block';

        const searchQuery = logSearchInput.value;
        const logLevel = logLevelFilter.value;
        const logDate = logDateFilter.value;

        let url = `/api/logs?page=${currentPage}`;
        if (searchQuery) url += `&search=${searchQuery}`;
        if (logLevel) url += `&level=${logLevel}`;
        if (logDate) url += `&date=${logDate}`;

        try {
            const response = await fetch(url);
            const data = await response.json();

            if (data.logs.length === 0 && currentPage === 1) {
                noLogsMessage.style.display = 'block';
                loadMoreButton.style.display = 'none';
                logsTable.style.display = 'none';
                loadingIndicator.style.display = 'none';
                return;
            }

            data.logs.forEach(log => {
                const row = logTableBody.insertRow();
                let badgeClass = 'badge-info';
                if (log.level === 'WARNING') badgeClass = 'badge-warning';
                if (log.level === 'ERROR') badgeClass = 'badge-danger';

                row.innerHTML = `
                    <td style="white-space: nowrap; color: var(--text-muted); width: 180px;">${log.timestamp}</td>
                    <td style="width: 100px;">
                        <span class="badge ${badgeClass}">${log.level}</span>
                    </td>
                    <td style="font-family: monospace; font-size: 0.85rem; color: var(--text-main);">${log.message}</td>
                `;
            });

            hasMoreLogs = data.has_more;
            currentPage = data.next_page;

            if (!hasMoreLogs) {
                loadMoreButton.style.display = 'none';
            }
        } catch (error) {
            console.error('Error fetching logs:', error);
        } finally {
            loadMoreButton.disabled = false;
            loadMoreButton.textContent = 'Load More Logs';
            loadingIndicator.style.display = 'none';
        }
    }

    function debounce(func, delay) {
        let timeout;
        return function (...args) {
            const context = this;
            clearTimeout(timeout);
            loadingIndicator.style.display = 'block';
            timeout = setTimeout(() => {
                func.apply(context, args);
            }, delay);
        };
    }

    const debouncedFetchLogs = debounce(() => fetchLogs(true), 800);

    loadMoreButton.addEventListener('click', () => fetchLogs());
    logSearchInput.addEventListener('input', debouncedFetchLogs);
    logLevelFilter.addEventListener('change', debouncedFetchLogs);
    logDateFilter.addEventListener('change', debouncedFetchLogs);

    // Initial load
    fetchLogs();
</script>
<style>
    .spin {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        100% {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}