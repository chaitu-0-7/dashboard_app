{% extends "base.html" %}

{% block title %}Token Management - Nifty Shop{% endblock %}
{% block page_title %}API Connection{% endblock %}
{% block page_subtitle %}Manage your broker API authentication tokens{% endblock %}

{% block content %}
<!-- Fyers Section -->
<div class="card mb-4">
    <div class="card-header">
        <h3 class="card-title">Fyers Connection</h3>
        {% if fyers_status == 'VALID' %}
        <span class="badge badge-success">Connected</span>
        {% elif fyers_status == 'EXPIRED_ACCESS_TOKEN_REFRESHABLE' %}
        <span class="badge badge-warning">Refresh Required</span>
        {% else %}
        <span class="badge badge-danger">Disconnected</span>
        {% endif %}
    </div>

    <div class="p-4">
        {% if fyers_status == 'VALID' %}
        <div class="flex-center flex-column p-4 mb-4"
            style="background: rgba(16, 185, 129, 0.1); border-radius: var(--radius-md); border: 1px solid rgba(16, 185, 129, 0.2);">
            <i data-feather="check-circle" class="text-success mb-2" style="width: 32px; height: 32px;"></i>
            <h3 class="text-success m-0">Fyers Connected</h3>
            <p class="text-muted text-center mt-2">Your Fyers API token is valid and active.</p>
        </div>

        <div class="mt-4"
            style="display: flex; flex-direction: row; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px;">
            <form action="/refresh-token-action" method="post" style="margin: 0;">
                <button type="submit" class="btn btn-outline">
                    <i data-feather="refresh-cw" style="width: 16px; margin-right: 6px;"></i> Try Auto-Refresh
                </button>
            </form>

            <button id="manual-auth-button-valid" class="btn btn-primary">
                <i data-feather="key" style="width: 16px; margin-right: 6px;"></i> Login with Fyers
            </button>
        </div>

        {% elif fyers_status == 'EXPIRED_ACCESS_TOKEN_REFRESHABLE' %}
        <div class="flex-center flex-column p-4 mb-4"
            style="background: rgba(245, 158, 11, 0.1); border-radius: var(--radius-md); border: 1px solid rgba(245, 158, 11, 0.2);">
            <i data-feather="alert-triangle" class="text-warning mb-2" style="width: 32px; height: 32px;"></i>
            <h3 class="text-warning m-0">Token Expired</h3>
            <p class="text-muted text-center mt-2">The access token has expired but can be refreshed automatically.</p>
        </div>

        <div class="text-center">
            <form action="/refresh-token-action" method="post">
                <button type="submit" class="btn btn-primary">
                    <i data-feather="refresh-cw" style="width: 16px; margin-right: 6px;"></i> Refresh Token Now
                </button>
            </form>
        </div>

        {% else %}
        <div class="flex-center flex-column p-4 mb-4"
            style="background: rgba(239, 68, 68, 0.1); border-radius: var(--radius-md); border: 1px solid rgba(239, 68, 68, 0.2);">
            <i data-feather="x-circle" class="text-danger mb-2" style="width: 32px; height: 32px;"></i>
            <h3 class="text-danger m-0">Fyers Disconnected</h3>
            <p class="text-muted text-center mt-2">
                {% if fyers_status == 'EXPIRED_REFRESH_TOKEN_MANUAL_REQUIRED' %}
                Refresh token expired. Manual re-authorization required.
                {% else %}
                No tokens found. Please authorize the application.
                {% endif %}
            </p>
        </div>

        <div class="mt-4"
            style="display: flex; flex-direction: row; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px;">
            <form action="/refresh-token-action" method="post" style="margin: 0;">
                <button type="submit" class="btn btn-outline">
                    <i data-feather="refresh-cw" style="width: 16px; margin-right: 6px;"></i> Try Auto-Refresh
                </button>
            </form>

            <button id="manual-auth-button" class="btn btn-primary">
                <i data-feather="key" style="width: 16px; margin-right: 6px;"></i> Login with Fyers
            </button>
        </div>
        {% endif %}
    </div>
</div>

<div id="manual-auth-section" class="card mb-4"
    style="opacity: 0; max-height: 0; overflow: hidden; transition: all 0.5s ease-in-out;">
    <div class="card-header">
        <h3 class="card-title">Manual Authorization (Fyers)</h3>
    </div>
    <div class="p-4">
        <div class="mb-4">
            <h4 class="text-main mb-2" style="font-size: 1rem;">Step 1: Generate Auth Code</h4>
            <p class="text-muted text-sm mb-3">Click the button below to log in to Fyers and generate an authorization
                code. Copy the code from the URL after redirection.</p>
            <a href="{{ fyers_auth_url }}" target="_blank" class="btn btn-outline">
                <i data-feather="external-link" style="width: 16px; margin-right: 6px;"></i> Open Fyers Login
            </a>
        </div>

        <div class="mb-4">
            <h4 class="text-main mb-2" style="font-size: 1rem;">Step 2: Enter Code</h4>
            <p class="text-muted text-sm mb-3">Paste the <code>auth_code</code> from the redirected URL here.</p>

            <form id="auth-code-form" action="/token-callback" method="get" class="flex-center gap-2"
                style="align-items: stretch;">
                <input type="text" name="code" placeholder="Paste Auth Code here..."
                    style="flex: 1; padding: 0.75rem; background: var(--bg-app); border: 1px solid var(--border); color: var(--text-main); border-radius: var(--radius-md);">
                <button type="submit" class="btn btn-primary">Connect</button>
            </form>
            <p class="text-danger mt-2 text-sm" id="auth-code-error" style="display:none;">Please enter a valid Auth
                Code.</p>
        </div>
    </div>
</div>

<!-- Zerodha Section -->
<div class="card mb-4">
    <div class="card-header">
        <h3 class="card-title">Zerodha Kite Connection</h3>
        {% if zerodha_status == 'VALID' %}
        <span class="badge badge-success">Connected</span>
        {% else %}
        <span class="badge badge-danger">Disconnected</span>
        {% endif %}
    </div>

    <div class="p-4">
        {% if zerodha_status == 'VALID' %}
        <div class="flex-center flex-column p-4 mb-4"
            style="background: rgba(16, 185, 129, 0.1); border-radius: var(--radius-md); border: 1px solid rgba(16, 185, 129, 0.2);">
            <i data-feather="check-circle" class="text-success mb-2" style="width: 32px; height: 32px;"></i>
            <h3 class="text-success m-0">Zerodha Connected</h3>
            <p class="text-muted text-center mt-2">Your Zerodha API token is valid and active.</p>
        </div>

        <div class="mt-4"
            style="display: flex; flex-direction: row; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px;">
            <a href="{{ zerodha_auth_url }}" class="btn btn-outline">
                <i data-feather="refresh-cw" style="width: 16px; margin-right: 6px;"></i> Re-authenticate Zerodha
            </a>
        </div>

        {% else %}
        <div class="flex-center flex-column p-4 mb-4"
            style="background: rgba(239, 68, 68, 0.1); border-radius: var(--radius-md); border: 1px solid rgba(239, 68, 68, 0.2);">
            <i data-feather="x-circle" class="text-danger mb-2" style="width: 32px; height: 32px;"></i>
            <h3 class="text-danger m-0">Zerodha Disconnected</h3>
            <p class="text-muted text-center mt-2">No valid Zerodha token found. Please authorize.</p>
        </div>

        <div class="mt-4"
            style="display: flex; flex-direction: row; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px;">
            <a href="{{ zerodha_auth_url }}" class="btn btn-primary">
                <i data-feather="key" style="width: 16px; margin-right: 6px;"></i> Login with Zerodha
            </a>
        </div>

        <div class="mt-3 text-center">
            <p class="text-muted text-sm">
                <i data-feather="info" style="width: 14px; margin-right: 4px;"></i>
                Zerodha tokens expire daily at 6 AM IST. You'll need to re-login each day.
            </p>
        </div>
        {% endif %}
    </div>
</div>

{% if request.args.get('status') %}
<div class="fixed-bottom-right p-4" style="position: fixed; bottom: 20px; right: 20px; z-index: 100;">
    {% if request.args.get('status') == 'success' or request.args.get('status') == 'refreshed' %}
    <div class="alert alert-success animate-fade-in shadow-lg">
        <i data-feather="check" style="width: 16px; margin-right: 6px;"></i>
        {{ request.args.get('broker', 'Token').capitalize() }} updated successfully!
    </div>
    {% else %}
    <div class="alert alert-danger animate-fade-in shadow-lg">
        <i data-feather="alert-circle" style="width: 16px; margin-right: 6px;"></i>
        Operation failed: {{ request.args.get('message', 'Unknown error') }}
    </div>
    {% endif %}
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Auto-hide success messages after 5 seconds
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            setTimeout(() => {
                alert.style.opacity = '0';
                alert.style.transition = 'opacity 0.3s';
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        });

        // Fyers Manual Auth Logic
        const manualAuthButton = document.getElementById('manual-auth-button');
        const manualAuthButtonValid = document.getElementById('manual-auth-button-valid');
        const manualAuthSection = document.getElementById('manual-auth-section');
        const authCodeForm = document.getElementById('auth-code-form');
        const initialFyersStatus = "{{ fyers_status }}";

        function toggleAuthSection() {
            // Smooth animation
            manualAuthSection.style.opacity = '1';
            manualAuthSection.style.maxHeight = '1000px'; // Large enough to fit content

            setTimeout(() => {
                manualAuthSection.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        if (manualAuthButton) {
            manualAuthButton.addEventListener('click', toggleAuthSection);
        }

        if (manualAuthButtonValid) {
            manualAuthButtonValid.addEventListener('click', toggleAuthSection);
        }

        if (initialFyersStatus === 'EXPIRED_REFRESH_TOKEN_MANUAL_REQUIRED' || initialFyersStatus === 'NO_TOKENS_FOUND') {
            // Optional: Auto-show if strictly required
            // manualAuthSection.style.opacity = '1';
            // manualAuthSection.style.maxHeight = '1000px';
        }

        if (authCodeForm) {
            authCodeForm.addEventListener('submit', function (event) {
                const input = authCodeForm.querySelector('input[name="code"]');
                const errorMessage = document.getElementById('auth-code-error');

                if (!input.value.trim()) {
                    errorMessage.style.display = 'block';
                    event.preventDefault();
                } else {
                    errorMessage.style.display = 'none';
                }
            });
        }
    });
</script>
<style>
    .bg-success {
        background-color: var(--success);
    }

    .bg-warning {
        background-color: var(--warning);
    }

    .bg-danger {
        background-color: var(--danger);
    }

    .bg-panel {
        background-color: var(--bg-panel);
    }

    .shadow-lg {
        box-shadow: var(--shadow-lg);
    }

    .animate-fade-in {
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}