{% extends "base.html" %}

{% block title %}Token Management - Nifty Shop{% endblock %}
{% block page_title %}API Connection{% endblock %}
{% block page_subtitle %}Manage your broker API authentication tokens{% endblock %}

{% block content %}
<div class="mb-4">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-white">API Connection Status</h2>
    </div>

    {% if not brokers %}
    <div class="text-center p-8 border border-dashed border-slate-700 rounded-lg text-slate-500">
        <p class="mb-2">No brokers connected yet. Go to Settings to add one.</p>
    </div>
    {% endif %}

    {% for broker in brokers %}
    <div class="card mb-4">
        <div class="card-header flex justify-between items-center">
            <div class="flex items-center gap-2">
                <h3 class="card-title mb-0 flex items-center gap-2">
                    {{ broker.name }}
                    <span class="text-sm font-normal text-slate-400">({{ broker.type|title }})</span>
                </h3>

                {% if broker.type == 'fyers' %}
                <span class="badge badge-primary text-xs">Fyers</span>
                {% elif broker.type == 'zerodha' %}
                <span class="badge badge-warning text-xs">Zerodha</span>
                {% endif %}
            </div>



            <div class="flex items-center gap-3">
                {% if is_dev %}
                <button onclick="invalidateToken('{{ broker.broker_id }}')"
                    class="btn btn-sm btn-ghost text-red-500 hover:bg-red-500/10 hover:text-red-400 p-2"
                    title="[DEV] Invalidate Token">
                    <i data-feather="trash-2" style="width: 16px;"></i>
                </button>
                {% endif %}

                {% if broker.status == 'VALID' %}
                <span class="badge badge-success">Connected</span>
                {% elif 'REFRESHABLE' in broker.status %}
                <span class="badge badge-warning">Refresh Required</span>
                {% else %}
                <span class="badge badge-danger">Disconnected</span>
                {% endif %}
            </div>
        </div>

        <div class="p-4">
            <!-- Status Visual -->
            {% if broker.status == 'VALID' %}
            <div class="flex-center flex-column p-4 mb-4"
                style="background: rgba(16, 185, 129, 0.1); border-radius: var(--radius-md); border: 1px solid rgba(16, 185, 129, 0.2);">
                <i data-feather="check-circle" class="text-success mb-2" style="width: 32px; height: 32px;"></i>
                <h3 class="text-success m-0">{{ broker.name }} Connected</h3>
                <p class="text-muted text-center mt-2">API token is valid.</p>
                {% if broker.last_update %}
                <p class="text-xs text-muted mt-1">Updated: {{ broker.last_update.strftime('%Y-%m-%d %H:%M') }}</p>
                {% endif %}
            </div>
            {% elif 'REFRESHABLE' in broker.status %}
            <div class="flex-center flex-column p-4 mb-4"
                style="background: rgba(245, 158, 11, 0.1); border-radius: var(--radius-md); border: 1px solid rgba(245, 158, 11, 0.2);">
                <i data-feather="alert-triangle" class="text-warning mb-2" style="width: 32px; height: 32px;"></i>
                <h3 class="text-warning m-0">Refresh Required</h3>
                <p class="text-muted text-center mt-2">Access token expired but can be refreshed.</p>
                {% if broker.last_update %}
                <p class="text-xs text-muted mt-1">Old Token: {{ broker.last_update.strftime('%Y-%m-%d %H:%M') }}</p>
                {% endif %}
            </div>
            {% else %}
            <div class="flex-center flex-column p-4 mb-4"
                style="background: rgba(239, 68, 68, 0.1); border-radius: var(--radius-md); border: 1px solid rgba(239, 68, 68, 0.2);">
                <i data-feather="x-circle" class="text-danger mb-2" style="width: 32px; height: 32px;"></i>
                <h3 class="text-danger m-0">Disconnected</h3>
                <p class="text-muted text-center mt-2">
                    {% if broker.status == 'EXPIRED_REFRESH_TOKEN_MANUAL_REQUIRED' %}
                    Refresh token expired. Manual re-login required.
                    {% elif broker.status == 'EXPIRED/MISSING' and broker.type == 'zerodha' %}
                    Zerodha token expired (Daily reset). Please re-login.
                    {% else %}
                    No valid tokens found. Please authorize.
                    {% endif %}
                </p>
            </div>
            {% endif %}

            <!-- Actions -->
            <div class="mt-4 flex flex-wrap justify-center items-center gap-3">
                {% if broker.type == 'fyers' %}
                <!-- Fyers Actions -->
                <div class="w-100 flex flex-col gap-4">
                    {% if 'REFRESHABLE' in broker.status or broker.status == 'VALID' %}
                    <div class="flex justify-center">
                        <button onclick="refreshBrokerToken('{{ broker.broker_id }}')" class="btn btn-outline">
                            <i data-feather="refresh-cw" style="width: 16px; margin-right: 6px;"></i>
                            {% if broker.status == 'VALID' %}Force Refresh{% else %}Auto-Refresh Token{% endif %}
                        </button>
                    </div>
                    {% endif %}

                    <div class="text-center mt-3">
                        <button onclick="toggleManualAuth('{{ broker.broker_id }}')"
                            class="btn btn-sm btn-outline text-muted hover:text-white">
                            <i data-feather="key" style="width: 14px; margin-right: 6px;"></i>
                            {% if broker.status == 'VALID' %}Re-Authenticate Manually{% else %}Start Manual
                            Authorization{% endif %}
                        </button>
                    </div>

                    <!-- Manual Auth Section (Hidden by default) -->
                    <div id="manual-auth-section-{{ broker.broker_id }}" class="mt-4 hidden animate-fade-in">
                        <div class="p-4 border border-slate-700 rounded-lg bg-slate-900/50">
                            <h4
                                class="text-white font-medium mb-4 flex items-center gap-2 border-b border-slate-700 pb-2">
                                <i data-feather="key" class="text-blue-400" style="width: 16px;"></i>
                                Manual Authorization
                            </h4>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Step 1 -->
                                <div class="relative pl-6 border-l-2 border-slate-700">
                                    <div
                                        class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-slate-800 border-2 border-blue-500">
                                    </div>
                                    <h5 class="text-sm font-semibold text-blue-400 mb-2 uppercase tracking-wide">Step 1:
                                        Get Auth Code</h5>
                                    <p class="text-xs text-slate-400 mb-3">
                                        Click below to open the Fyers login page. Login successfully, and you will be
                                        redirected to a page that may fail to load.
                                        <br><span class="text-slate-500 italic">Look at the URL bar of that failed
                                            page.</span>
                                    </p>
                                    <a href="{{ broker.auth_url }}" target="_blank"
                                        class="btn btn-sm btn-outline w-full justify-center group hover:border-blue-500">
                                        <i data-feather="external-link" style="width: 14px; margin-right: 6px;"
                                            class="group-hover:text-blue-400"></i>
                                        Open Fyers Login
                                    </a>
                                </div>

                                <!-- Step 2 -->
                                <div class="relative pl-6 border-l-2 border-slate-700">
                                    <div
                                        class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-slate-800 border-2 border-purple-500">
                                    </div>
                                    <h5 class="text-sm font-semibold text-purple-400 mb-2 uppercase tracking-wide">Step
                                        2: Submit Code</h5>
                                    <p class="text-xs text-slate-400 mb-3">
                                        Copy the code from the URL parameter (e.g., <code>?auth_code=...</code>) and
                                        paste it below.
                                    </p>
                                    <div class="flex flex-col gap-2">
                                        <input type="text" id="auth_code_{{ broker.broker_id }}"
                                            placeholder="Paste Code Here..." class="form-control-dark"
                                            style="background-color: #1e293b; border: 1px solid #334155; color: white; border-radius: 0.5rem; padding: 10px 12px; width: 100%; outline: none;">
                                        <button onclick="submitManualAuth('{{ broker.broker_id }}')"
                                            class="btn btn-sm btn-primary justify-center">
                                            Authorize
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>



                </div>
            </div>

            {% elif broker.type == 'zerodha' %}
            <!-- Zerodha Actions -->
            <div class="flex justify-center">
                {% if broker.status == 'VALID' %}
                <a href="{{ broker.auth_url }}" class="btn btn-outline">
                    <i data-feather="refresh-cw" style="width: 16px; margin-right: 6px;"></i> Re-authenticate
                    Zerodha
                </a>
                {% else %}
                <a href="{{ broker.auth_url }}" class="btn btn-primary">
                    <i data-feather="key" style="width: 16px; margin-right: 6px;"></i> Login with Zerodha
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endfor %}
</div>

{% if request.args.get('status') %}
<div class="fixed-bottom-right p-4" style="position: fixed; bottom: 20px; right: 20px; z-index: 100;">
    {% if request.args.get('status') == 'success' or request.args.get('status') == 'refreshed' %}
    <div class="alert alert-success animate-fade-in shadow-lg">
        <i data-feather="check" style="width: 16px; margin-right: 6px;"></i>
        {{ request.args.get('broker', 'Token').capitalize() }} updated successfully!
    </div>
    {% else %}
    <div class="alert alert-danger animate-fade-in shadow-lg">
        <i data-feather="alert-circle" style="width: 16px; margin-right: 6px;"></i>
        Operation failed: {{ request.args.get('message', 'Unknown error') }}
    </div>
    {% endif %}
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    feather.replace();

    // Client-side refresh logic (reusing backend API)
    function refreshBrokerToken(brokerId) {
        // Show loading state if possible
        const btn = event.currentTarget;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="animate-spin" data-feather="loader" style="width: 16px; margin-right: 6px;"></i> Refreshing...';
        feather.replace();
        btn.disabled = true;

        fetch('/broker/' + brokerId + '/refresh', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(r => r.json())
            .then(data => {
                if (data.redirect) {
                    window.location.href = data.redirect;
                } else if (data.success) {
                    // Show success and reload
                    btn.innerHTML = '<i data-feather="check" style="width: 16px; margin-right: 6px;"></i> Success';
                    feather.replace();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert('Refresh Failed: ' + data.message);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            })
            .catch(e => {
                alert('Error refreshing token');
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
    }

    function submitManualAuth(brokerId) {
        const input = document.getElementById('auth_code_' + brokerId);
        const code = input.value.trim();
        if (!code) {
            alert('Please enter the auth code.');
            return;
        }

        const btn = event.currentTarget;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="animate-spin" data-feather="loader" style="width: 16px; margin-right: 6px;"></i> Verifying...';
        feather.replace();
        btn.disabled = true;

        fetch('/broker/' + brokerId + '/manual-auth', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ auth_code: code })
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    btn.className = 'btn btn-success text-sm px-3 py-2';
                    btn.innerHTML = '<i data-feather="check" style="width: 16px; margin-right: 6px;"></i> Success';
                    feather.replace();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert('Auth Failed: ' + data.message);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            })
            .catch(e => {
                alert('Error submitting code');
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
    }

    function invalidateToken(brokerId) {
        if (!confirm('Are you sure you want to invalidate this token? (DEV ONLY)')) return;

        const btn = event.currentTarget;
        btn.innerHTML = 'Invalidating...';
        btn.disabled = true;

        fetch('/broker/' + brokerId + '/invalidate', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                    btn.disabled = false;
                    btn.innerHTML = 'Retry Invalidate';
                }
            });
    }

    function toggleManualAuth(brokerId) {
        const section = document.getElementById('manual-auth-section-' + brokerId);
        if (section.classList.contains('hidden')) {
            section.classList.remove('hidden');
            // Optional: Scroll into view
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
            section.classList.add('hidden');
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Auto-hide success messages after 5 seconds
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            setTimeout(() => {
                alert.style.opacity = '0';
                alert.style.transition = 'opacity 0.3s';
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        });
    });
</script>
<style>
    .bg-success {
        background-color: var(--success);
    }

    .bg-warning {
        background-color: var(--warning);
    }

    .bg-danger {
        background-color: var(--danger);
    }

    .bg-panel {
        background-color: var(--bg-panel);
    }

    .shadow-lg {
        box-shadow: var(--shadow-lg);
    }

    .animate-spin {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    .animate-fade-in {
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .form-control-dark:focus {
        border-color: #8b5cf6 !important;
        /* Purple-500 */
        box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.3);
    }
</style>
{% endblock %}