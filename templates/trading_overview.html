{% extends "base.html" %}

{% block title %}Trading Overview - Nifty Shop{% endblock %}
{% block page_title %}Trading Overview{% endblock %}
{% block page_subtitle %}Detailed analysis of your trading performance{% endblock %}

{% block content %}
<!-- KPI Metrics -->
<div class="metrics-grid">
    {% if total_pnl is not none %}
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Total P&L</h3>
            <i data-feather="trending-up" class="text-muted" style="width: 16px;"></i>
        </div>
        <p class="metric-value {% if total_pnl > 0 %}text-success{% elif total_pnl < 0 %}text-danger{% endif %}">
            ₹{{ '%.2f' | format(total_pnl) }}
        </p>
        <div class="metric-trend">
            <span class="text-muted">All time realized</span>
        </div>
    </div>
    {% endif %}

    {% if win_loss_ratio is not none %}
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Win/Loss Ratio</h3>
            <i data-feather="percent" class="text-muted" style="width: 16px;"></i>
        </div>
        <p class="metric-value">{{ '%.2f' | format(win_loss_ratio) }}</p>
        <div class="metric-trend">
            <span class="text-muted">Winning trades vs losing trades</span>
        </div>
    </div>
    {% endif %}

    {% if total_trades is not none %}
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Trades</h3>
            <i data-feather="activity" class="text-info" style="width: 16px;"></i>
        </div>
        <div style="display: flex; gap: 2rem; padding: 0.5rem 0;">
            <div style="flex: 1; text-align: center;">
                <span class="text-muted small" style="display: block; margin-bottom: 0.5rem;">Open</span>
                <p class="metric-value text-primary mb-0" style="font-size: 1.5rem;">{{ open_trades_count }}</p>
            </div>
            <div style="width: 1px; background-color: #334155;"></div>
            <div style="flex: 1; text-align: center;">
                <span class="text-muted small" style="display: block; margin-bottom: 0.5rem;">Closed</span>
                <p class="metric-value text-success mb-0" style="font-size: 1.5rem;">{{ closed_trades_count }}</p>
            </div>
        </div>
    </div>
    {% endif %}

    {% if max_drawdown is not none %}
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Max Drawdown</h3>
            <i data-feather="trending-down" class="text-danger" style="width: 16px;"></i>
        </div>
        <p class="metric-value text-danger">
            {{ '%.2f' | format(max_drawdown) }}%
        </p>
    </div>
    {% endif %}
</div>

<!-- Charts -->
<div class="charts-grid mb-4">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Cumulative P&L Growth</h3>
        </div>
        <div class="chart-container">
            <canvas id="cumulativePnlChart"></canvas>
        </div>
    </div>
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Drawdown (%)</h3>
        </div>
        <div class="chart-container">
            <canvas id="drawdownChart"></canvas>
        </div>
    </div>
</div>


<div class="card">
    <div class="card-header">
        <h3 class="card-title">Portfolio P&L Performance</h3>
    </div>
    <div class="chart-container">
        <canvas id="portfolioAllocationChart"></canvas>
    </div>
</div>

<!-- Current Positions -->
<div class="card mb-4">
    <div class="card-header">
        <h3 class="card-title">Current Positions</h3>
    </div>
    {% if current_positions %}
    <div class="table-container" style="border: none; margin-bottom: 0;">
        <table>
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>Qty</th>
                    <th>Avg Price</th>
                    <th>LTP</th>
                    <th>P&L (₹)</th>
                    <th>P&L (%)</th>
                </tr>
            </thead>
            <tbody>
                {% for position in current_positions %}
                <tr>
                    <td style="font-weight: 500;">{{ position.symbol }}</td>
                    <td>{{ position.quantity }}</td>
                    <td>₹{{ '%.2f' | format(position.avg_price) }}</td>
                    <td>₹{{ '%.2f' | format(position.current_price) }}</td>
                    <td class="{% if position.pnl > 0 %}text-success{% elif position.pnl < 0 %}text-danger{% endif %}"
                        style="font-weight: 600;">
                        ₹{{ '%.2f' | format(position.pnl) }}
                    </td>
                    <td>
                        <span
                            class="badge {% if position.pnl_pct > 0 %}badge-success{% elif position.pnl_pct < 0 %}badge-danger{% endif %}">
                            {{ '%.2f' | format(position.pnl_pct) }}%
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="p-4 text-center text-muted">No open positions currently.</div>
    {% endif %}
</div>

<!-- Closed Trades -->
<div class="card mb-4">
    <div class="card-header">
        <h3 class="card-title">Closed Trades History</h3>
    </div>
    {% if closed_trades %}
    <div class="table-container" style="border: none; margin-bottom: 0;">
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Symbol</th>
                    <th>Action</th>
                    <th>Qty</th>
                    <th>Price</th>
                    <th>P&L (₹)</th>
                    <th>P&L (%)</th>
                </tr>
            </thead>
            <tbody>
                {% for trade in closed_trades %}
                <tr>
                    <td class="text-muted">{{ trade.date.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td style="font-weight: 500;">{{ trade.symbol }}</td>
                    <td>
                        <span
                            class="badge {% if trade.action == 'BUY' %}badge-success{% else %}badge-danger{% endif %}">
                            {{ trade.action }}
                        </span>
                    </td>
                    <td>{{ trade.quantity }}</td>
                    <td>₹{{ '%.2f' | format(trade.price) }}</td>
                    <td class="{% if trade.profit > 0 %}text-success{% elif trade.profit < 0 %}text-danger{% endif %}"
                        style="font-weight: 600;">
                        ₹{{ '%.2f' | format(trade.profit) }}
                    </td>
                    <td>
                        <span
                            class="badge {% if trade.profit_pct > 0 %}badge-success{% elif trade.profit_pct < 0 %}badge-danger{% endif %}">
                            {{ '%.2f' | format(trade.profit_pct) }}%
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="p-4 text-center text-muted">No closed trades history found.</div>
    {% endif %}
</div>

<!-- Manually Closed Trades -->
{% if manually_closed_trades %}
<div class="card mb-4">
    <div class="card-header">
        <h3 class="card-title">Manually Closed Trades</h3>
    </div>
    <div class="table-container" style="border: none; margin-bottom: 0;">
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Symbol</th>
                    <th>Qty</th>
                    <th>Close Price</th>
                    <th>Comment</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for trade in manually_closed_trades %}
                <tr id="trade-row-{{ trade._id }}">
                    <td class="text-muted">{{ trade.date.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td style="font-weight: 500;">{{ trade.symbol }}</td>
                    <td>{{ trade.quantity }}</td>
                    <td>₹{{ trade.price }}</td>
                    <td class="text-muted">{{ trade.comment }}</td>
                    <td>
                        <div class="flex-center gap-2" style="justify-content: flex-start;">
                            <button class="btn btn-outline btn-sm"
                                onclick="openEditModal('{{ trade._id|string }}', '{{ trade.symbol }}', '{{ trade.quantity }}', '{{ trade.price }}', '{{ trade.date.strftime('%Y-%m-%dT%H:%M') }}')">
                                <i data-feather="edit-2" style="width: 14px;"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="openDeleteModal('{{ trade._id|string }}')">
                                <i data-feather="trash-2" style="width: 14px;"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Modals -->
<div id="editModal" class="modal-overlay"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; align-items: center; justify-content: center;">
    <div class="card" style="width: 100%; max-width: 400px; margin: 2rem;">
        <div class="card-header">
            <h3 class="card-title">Edit Trade</h3>
            <button onclick="closeEditModal()"
                style="background: none; border: none; color: var(--text-muted); cursor: pointer;"><i
                    data-feather="x"></i></button>
        </div>
        <div style="padding: 1rem 0;">
            <p class="mb-4">Symbol: <strong id="edit-symbol" class="text-main"></strong></p>
            <p class="mb-4">Quantity: <strong id="edit-quantity" class="text-main"></strong></p>

            <div class="mb-4">
                <label
                    style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.875rem;">Close
                    Price</label>
                <input type="number" step="0.01" id="edit-price"
                    style="width: 100%; padding: 0.5rem; background: var(--bg-app); border: 1px solid var(--border); color: var(--text-main); border-radius: var(--radius-sm);">
            </div>

            <div class="mb-4">
                <label
                    style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.875rem;">Close
                    Date</label>
                <input type="datetime-local" id="edit-date"
                    style="width: 100%; padding: 0.5rem; background: var(--bg-app); border: 1px solid var(--border); color: var(--text-main); border-radius: var(--radius-sm);">
            </div>

            <input type="hidden" id="edit-trade-id">
        </div>
        <div class="flex-between">
            <button class="btn btn-outline" onclick="closeEditModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveTrade()">Save Changes</button>
        </div>
    </div>
</div>

<div id="deleteModal" class="modal-overlay"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; align-items: center; justify-content: center;">
    <div class="card" style="width: 100%; max-width: 400px; margin: 2rem;">
        <div class="card-header">
            <h3 class="card-title">Delete Trade</h3>
            <button onclick="closeDeleteModal()"
                style="background: none; border: none; color: var(--text-muted); cursor: pointer;"><i
                    data-feather="x"></i></button>
        </div>
        <div style="padding: 1.5rem 0;">
            <p class="text-muted">Are you sure you want to delete this trade? This action cannot be undone.</p>
            <input type="hidden" id="delete-trade-id">
        </div>
        <div class="flex-between">
            <button class="btn btn-outline" onclick="closeDeleteModal()">Cancel</button>
            <button class="btn btn-danger" onclick="confirmDelete()">Delete Trade</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Cumulative P&L Chart
        const cumulativePnlData = {{ cumulative_pnl_data | safe
    }};
    const cumulativePnlLabels = cumulativePnlData.map(d => d.date);
    const cumulativePnlValues = cumulativePnlData.map(d => d.pnl);
    const cumulativePnlCtx = document.getElementById('cumulativePnlChart').getContext('2d');
    const gradient = cumulativePnlCtx.createLinearGradient(0, 0, 0, 300);
    gradient.addColorStop(0, 'rgba(16, 185, 129, 0.2)'); // Emerald with opacity
    gradient.addColorStop(1, 'rgba(16, 185, 129, 0)');

    new Chart(cumulativePnlCtx, {
        type: 'line',
        data: {
            labels: cumulativePnlLabels,
            datasets: [{
                label: 'Cumulative P&L',
                data: cumulativePnlValues,
                backgroundColor: gradient,
                borderColor: '#10b981',
                borderWidth: 2,
                pointBackgroundColor: '#1e293b',
                pointBorderColor: '#10b981',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#1e293b',
                    titleColor: '#f8fafc',
                    bodyColor: '#cbd5e1',
                    borderColor: '#334155',
                    borderWidth: 1,
                    padding: 10,
                    callbacks: {
                        label: function (context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            if (context.parsed.y !== null) {
                                label += new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(context.parsed.y);
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    grid: { color: '#334155', drawBorder: false },
                    ticks: { color: '#94a3b8' }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#94a3b8' }
                }
            }
        }
    });
    // Drawdown Chart
    const drawdownData = {{ drawdown_chart_data | safe }};
    const drawdownCtx = document.getElementById('drawdownChart').getContext('2d');
    new Chart(drawdownCtx, {
        type: 'line',
        data: {
            labels: drawdownData.labels,
            datasets: [{
                label: 'Drawdown',
                data: drawdownData.values,
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 2,
                pointBackgroundColor: '#ef4444'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function (context) {
                            return 'Drawdown: ' + context.parsed.y.toFixed(2) + '%';
                        }
                    }
                }
            },
            scales: {
                y: {
                    grid: { color: '#334155', drawBorder: false },
                    ticks: { color: '#94a3b8' }
                },
                x: {
                    grid: { display: false },
                    ticks: { display: false }
                }
            }
        }
    });

    // Portfolio P&L Performance Chart
    const portfolioData = {{ portfolio_data | safe }};
    const portfolioCtx = document.getElementById('portfolioAllocationChart').getContext('2d');

    portfolioData.sort((a, b) => b.value - a.value);

    const portfolioLabels = portfolioData.map(p => p.symbol);
    const portfolioValues = portfolioData.map(p => p.value);
    const backgroundColors = portfolioValues.map(v => v >= 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0.7)');
    const borderColors = portfolioValues.map(v => v >= 0 ? '#10b981' : '#ef4444');

    new Chart(portfolioCtx, {
        type: 'bar',
        data: {
            labels: portfolioLabels,
            datasets: [{
                label: 'P&L (₹)',
                data: portfolioValues,
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            const dataIndex = context.dataIndex;
                            const pnlValue = context.parsed.x;
                            const positionData = portfolioData[dataIndex];

                            let label = 'P&L: ';
                            label += new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(pnlValue);

                            // Calculate percentage if we have the necessary data
                            if (positionData && positionData.percentage !== undefined) {
                                label += ` (${positionData.percentage.toFixed(2)}%)`;
                            }

                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { color: '#334155', drawBorder: false },
                    ticks: { color: '#94a3b8' }
                },
                y: {
                    grid: { display: false },
                    ticks: { color: '#94a3b8' }
                }
            }
        }
    });
    });

    function openEditModal(tradeId, symbol, quantity, price, date) {
        document.getElementById('edit-trade-id').value = tradeId;
        document.getElementById('edit-symbol').innerText = symbol;
        document.getElementById('edit-quantity').innerText = quantity;
        document.getElementById('edit-price').value = price;
        document.getElementById('edit-date').value = date;
        document.getElementById('editModal').style.display = 'flex';
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    function openDeleteModal(tradeId) {
        document.getElementById('delete-trade-id').value = tradeId;
        document.getElementById('deleteModal').style.display = 'flex';
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
    }

    function saveTrade() {
        const tradeId = document.getElementById('edit-trade-id').value;
        const price = document.getElementById('edit-price').value;
        const date = document.getElementById('edit-date').value;

        const formData = new FormData();
        formData.append('close_price', price);
        formData.append('close_date', date);

        fetch('/update_manual_trade/' + tradeId, {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error updating trade: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating the trade.');
            });
    }

    function confirmDelete() {
        const tradeId = document.getElementById('delete-trade-id').value;
        fetch('/delete_manual_trade/' + tradeId, {
            method: 'POST',
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error deleting trade: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the trade.');
            });
    }
</script>
{% endblock %}